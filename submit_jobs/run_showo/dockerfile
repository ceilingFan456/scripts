FROM nvidia/cuda:12.1.1-cudnn8-devel-ubuntu22.04

ENV DEBIAN_FRONTEND=noninteractive
WORKDIR /workspace

# Speed up some compiles (flash-attn)
ARG MAX_JOBS=16
ENV MAX_JOBS=${MAX_JOBS}

# --- system deps ---
RUN apt-get update && apt-get install -y --no-install-recommends \
    git git-lfs curl ca-certificates \
    build-essential cmake ninja-build pkg-config \
    libcurl4-openssl-dev \
    libssl-dev libffi-dev \
    python3 python3-pip python3-venv python3-dev \
    && rm -rf /var/lib/apt/lists/*



RUN git lfs install
RUN python3 -m pip install --upgrade pip wheel setuptools

# --- torch cu121 ---
RUN pip install --no-cache-dir \
    torch==2.2.1 torchvision==0.17.1 torchaudio==2.2.1 \
    --index-url https://download.pytorch.org/whl/cu121

# --- install show-o ---
COPY show-o-dev /workspace/show-o-dev
RUN pip install --no-cache-dir -r /workspace/show-o-dev/requirements.txt && \
    pip install --no-build-isolation --no-cache-dir "flash-attn==2.5.7" && \
    pip install --no-cache-dir -e /workspace/show-o-dev

# --- install MedEvalKit ---
COPY MedEValKit-dev /workspace/MedEValKit-dev
RUN pip install --no-cache-dir -r /workspace/MedEValKit-dev/medevalkit/requirements.txt && \
    pip install --no-cache-dir \
        "networkx>=3.4.2" \
        'open_clip_torch[training]' \
        datasets google-generativeai \
        openai azure-identity qwen-vl-utils \
        nltk rouge mathruler tenacity pylatexenc pydash && \
    pip install --no-cache-dir -r /workspace/MedEValKit-dev/medevalkit/requirements_additional.txt && \
    pip install --no-cache-dir -e /workspace/MedEValKit-dev/medevalkit/LLaVA-NeXT && \
    pip install --no-cache-dir -e /workspace/MedEValKit-dev

# --- install MedSAM ---
COPY MedSAM /workspace/MedSAM
RUN pip install --no-cache-dir -e /workspace/MedSAM

# --- pin numpy like your script (only if really required) ---
RUN pip install --no-cache-dir numpy==1.24.4

# --- vllm (heavy; keep last so earlier layers cache) ---
RUN pip install --no-cache-dir vllm

CMD ["/bin/bash"]
